<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Editor</title>
<style>
:root {
    --bg-color: #0d1117;
    --text-color: #c9d1d9;
    --accent-color: #61afef; /* Softer Blue */
    --border-color: #282c34; /* Softer Border */
    --caret-color: #61afef;
    --selection-bg: rgba(97, 175, 239, 0.3);
    --font-mono: 'Fira Code', 'JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
    --font-size: 15px;
}
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-mono);
    overflow: hidden;
}
.editor-container {
    display: flex;
    height: 100vh;
    width: 100vw;
}
#line-numbers {
    width: 50px;
    padding: 15px 5px 15px 15px;
    box-sizing: border-box;
    text-align: right;
    color: var(--border-color);
    user-select: none;
    pointer-events: none;
    overflow: hidden;
    font-size: var(--font-size);
    line-height: 1.5;
    background-color: var(--bg-color);
    white-space: pre;
}
textarea#editor {
    flex-grow: 1;
    height: 100%;
    box-sizing: border-box;
    border: none;
    outline: none;
    resize: none;
    white-space: pre;
    overflow-wrap: normal;
    overflow: auto;
    background-color: transparent;
    color: var(--text-color);
    font-family: var(--font-mono);
    font-size: var(--font-size);
    padding: 15px;
    caret-color: var(--caret-color);
    line-height: 1.5;
}
textarea::selection {
    background-color: var(--selection-bg);
}
.modal {
    display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); width: 450px;
    background-color: var(--bg-color); border: 1px solid var(--border-color);
    color: var(--text-color); z-index: 100; padding: 20px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    max-height: 80vh;
    overflow-y: auto;
}
.modal h1, .modal h2 {
    margin-top: 0; text-align: left; color: var(--accent-color);
    font-weight: normal; font-size: 1.2em; border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px; margin-bottom: 15px;
}
.modal h2 { font-size: 1em; margin-bottom: 10px; }
.modal ul { list-style-type: none; padding-left: 0; }
.modal li { margin-bottom: 8px; font-size: 0.9em; }
.modal li strong { display: inline-block; width: 160px; color: var(--accent-color); }
.modal-close-btn {
    position: absolute; top: 15px; right: 20px; font-size: 24px;
    color: var(--border-color); cursor: pointer; background: none;
    border: none; transition: color 0.2s;
}
.modal-close-btn:hover { color: var(--text-color); }
#search-modal .input-group { margin-bottom: 15px; }
#search-modal label { display: block; margin-bottom: 5px; font-size: 0.9em; }
#search-modal #match-count { float: right; font-size: 0.9em; color: #888; }
#search-modal input {
    width: 100%; background-color: #161b22; border: 1px solid var(--border-color);
    color: var(--text-color); padding: 8px; box-sizing: border-box;
    font-family: inherit; font-size: 0.9em;
}
#search-modal .button-group { display: flex; justify-content: space-between; gap: 10px; }
#search-modal button {
    flex-grow: 1; background-color: #21262d; border: 1px solid var(--border-color);
    color: var(--text-color); padding: 8px 12px; cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
}
#search-modal button:hover { background-color: #30363d; border-color: var(--accent-color); }
</style>
</head>
<body>

<div class="editor-container">
    <div id="line-numbers">1</div>
    <textarea id="editor" spellcheck="false" autofocus=""></textarea>
</div>

<div id="help-modal" class="modal">
    <button id="help-modal-close-btn" class="modal-close-btn" aria-label="Close">×</button>
    <h1 id="help-main-title"></h1>
    <h2 id="help-title"></h2>
    <ul id="help-list"></ul>
</div>

<div id="search-modal" class="modal">
    <button id="search-modal-close-btn" class="modal-close-btn" aria-label="Close">×</button>
    <h1><span id="search-main-title"></span></h1>
    <h2><span id="search-title"></span></h2>
    <div class="input-group">
        <label for="find-input">
            <span id="find-label-text"></span>
            <span id="match-count"></span>
        </label>
        <input type="text" id="find-input">
    </div>
    <div class="input-group">
        <label for="replace-input" id="replace-label"></label>
        <input type="text" id="replace-input">
    </div>
    <div class="button-group">
        <button id="find-next-btn"></button>
        <button id="replace-btn"></button>
        <button id="replace-all-btn"></button>
    </div>
</div>

<script>
const CodeEditor = {
    // Configuration and constants
    config: {
        debounceDelay: 150, // ms for debouncing inputs
        indentUnit: '  ',   // 2 spaces for indentation
    },

    // Application state
    state: {
        fileHandle: null,
        fileName: 'Untitled',
        hasUnsavedChanges: false,
        searchResults: { term: '', indices: [], currentIndex: -1 },
    },

    // Cached DOM elements
    elements: {},

    // Language strings
    lang: {
        title: "Code Editor",
        untitled: "Untitled",
        mainTitle: "Code Editor for HTML CSS JS",
        helpTitle: "Shortcuts",
        helpOpenFile: "Open File",
        helpSaveFile: "Save File",
        helpNewFile: "New File",
        helpSearchReplace: "Search & Replace",
        helpToggleHelp: "Show/Hide Help",
        helpCleanWhitespace: "Clean Whitespace",
        helpRemoveEmptyLines: "Remove Empty Lines", // NEW
        helpPreview: "Preview in New Tab", // NEW
        helpIndent: "Indent",
        helpOutdent: "Outdent",
        helpNewTab: "Open in New Tab",
        helpJumpStyle: "Jump to &lt;style&gt;",
        helpJumpScript: "Jump to &lt;script&gt;",
        helpJumpBody: "Jump to &lt;body&gt;",
        searchTitle: "Search & Replace",
        findLabel: "Find:",
        replaceLabel: "Replace with:",
        findNext: "Find Next",
        replace: "Replace",
        replaceAll: "Replace All",
        matches: "matches",
        unsavedChanges: "You have unsaved changes. Are you sure?",
        unsavedChangesLost: "You have unsaved changes that will be lost. Are you sure?",
        unsupportedApi: "Your browser does not support the modern File System API.",
        userAbortedOpen: "User aborted file opening.",
        userAbortedSave: "User aborted the save dialog.",
        saveError: "Error: Could not save the file."
    },

    // Main initialization function
    init() {
        this.cacheDOMElements();
        this.updateStaticUIText();
        this.bindEventListeners();
        this.updateLineNumbers();
        
        if (!localStorage.getItem('editorVisited')) {
            this.toggleModal('help');
            localStorage.setItem('editorVisited', 'true');
        } else {
            this.elements.editor.focus();
        }
    },

    // Cache all necessary DOM elements
    cacheDOMElements() {
        this.elements = {
            editor: document.getElementById('editor'),
            lineNumbers: document.getElementById('line-numbers'),
            helpModal: document.getElementById('help-modal'),
            helpModalCloseBtn: document.getElementById('help-modal-close-btn'),
            searchModal: document.getElementById('search-modal'),
            searchModalCloseBtn: document.getElementById('search-modal-close-btn'),
            findInput: document.getElementById('find-input'),
            replaceInput: document.getElementById('replace-input'),
            findNextBtn: document.getElementById('find-next-btn'),
            replaceBtn: document.getElementById('replace-btn'),
            replaceAllBtn: document.getElementById('replace-all-btn'),
            matchCountSpan: document.getElementById('match-count'),
            helpMainTitle: document.getElementById('help-main-title'),
            helpTitle: document.getElementById('help-title'),
            helpList: document.getElementById('help-list'),
            searchMainTitle: document.getElementById('search-main-title'),
            searchTitle: document.getElementById('search-title'),
            findLabelText: document.getElementById('find-label-text'),
            replaceLabel: document.getElementById('replace-label'),
        };
    },
    
    // Bind all event listeners
    bindEventListeners() {
        const editor = this.elements.editor;
        const findInput = this.elements.findInput;

        editor.addEventListener('scroll', () => this.elements.lineNumbers.scrollTop = editor.scrollTop);
        editor.addEventListener('input', this.handleEditorInput.bind(this));
        editor.addEventListener('keydown', this.handleEditorKeyDown.bind(this));
        
        findInput.addEventListener('input', this.utils.debounce(this.updateSearchResults.bind(this), this.config.debounceDelay));
        
        this.elements.helpModalCloseBtn.addEventListener('click', () => this.toggleModal('help'));
        this.elements.searchModalCloseBtn.addEventListener('click', () => this.toggleModal('search'));
        
        this.elements.findNextBtn.addEventListener('click', this.findNext.bind(this));
        this.elements.replaceBtn.addEventListener('click', this.replaceCurrent.bind(this));
        this.elements.replaceAllBtn.addEventListener('click', this.replaceAll.bind(this));
        
        document.addEventListener('keydown', this.handleGlobalKeyDown.bind(this));
        window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));
        window.addEventListener('focus', () => {
             if (this.elements.helpModal.style.display !== 'block' && this.elements.searchModal.style.display !== 'block') {
                editor.focus();
            }
        });
    },

    // Centralized handler for all modal toggling
    toggleModal(modalName) {
        const modal = this.elements[`${modalName}Modal`];
        const isVisible = modal.style.display === 'block';
        modal.style.display = isVisible ? 'none' : 'block';

        if (!isVisible) {
            if (modalName === 'search') {
                this.elements.findInput.focus();
                this.elements.findInput.select();
                this.updateSearchResults();
            }
        } else {
            this.elements.editor.focus();
        }
    },
    
    // --- Core Editor Features ---

    updateLineNumbers() {
        const text = this.elements.editor.value;
        let lineCount = 1;
        for (let i = 0; i < text.length; i++) {
            if (text[i] === '\n') lineCount++;
        }
        
        const numbers = Array.from({ length: lineCount }, (_, i) => i + 1).join('\n');
        if (this.elements.lineNumbers.textContent !== numbers) {
            this.elements.lineNumbers.textContent = numbers;
        }
    },

    // NEW: Generic code cleaning/modification helper function
    _modifyContent(regex, replacement) {
        const editor = this.elements.editor;
        const originalValue = editor.value;
        const newValue = originalValue.replace(regex, replacement);

        if (originalValue !== newValue) {
            const originalScrollTop = editor.scrollTop;
            editor.value = newValue;
            editor.scrollTop = originalScrollTop;
            this.setUnsavedChanges(true);
            this.updateLineNumbers();
        }
    },

    cleanWhitespace() {
        this._modifyContent(/^\s*$\r?\n/gm, '');
    },

    removeEmptyLines() { // NEW
        // WARNING: This can be destructive to JS template literals with intentional blank lines.
        this._modifyContent(/(\r?\n){2,}/g, '\n');
    },
    
    previewInNewTab() { // NEW
        const blob = new Blob([this.elements.editor.value], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        // The URL is temporary and will be released when the document is unloaded.
    },
    
    async openFile() {
        if (this.state.hasUnsavedChanges && !confirm(this.lang.unsavedChangesLost)) return;
        if (!('showOpenFilePicker' in window)) return alert(this.lang.unsupportedApi);
        
        try {
            const [fileHandle] = await window.showOpenFilePicker();
            this.state.fileHandle = fileHandle;
            const file = await fileHandle.getFile();
            this.elements.editor.value = await file.text();
            
            this.state.fileName = file.name;
            this.setUnsavedChanges(false);
            this.updateLineNumbers();
            this.elements.editor.scrollTop = 0;
            this.elements.editor.setSelectionRange(0, 0);
        } catch (err) {
            console.warn(this.lang.userAbortedOpen, err);
        }
    },

    newFile() {
        if (this.state.hasUnsavedChanges && !confirm(this.lang.unsavedChanges)) return;
        
        this.elements.editor.value = '';
        this.state.fileHandle = null;
        this.state.fileName = this.lang.untitled;
        this.setUnsavedChanges(false);
        this.updateLineNumbers();
        this.elements.editor.focus();
    },

    async saveFile() {
        if (!this.state.fileHandle) {
            try {
                this.state.fileHandle = await window.showSaveFilePicker({
                    suggestedName: this.state.fileName.endsWith('.txt') ? this.state.fileName.replace('.txt', '.html') : this.state.fileName,
                    types: [{
                        description: 'Web Files',
                        accept: {
                            'text/html': ['.html', '.htm'],
                            'text/css': ['.css'],
                            'application/javascript': ['.js'],
                            'text/plain': ['.txt', '.md'],
                        },
                    }],
                });
                this.state.fileName = this.state.fileHandle.name;
            } catch (err) {
                console.warn(this.lang.userAbortedSave, err);
                return;
            }
        }
        
        try {
            const writable = await this.state.fileHandle.createWritable();
            await writable.write(this.elements.editor.value);
            await writable.close();
            this.setUnsavedChanges(false);
        } catch (err) {
            console.error('Could not save file:', err);
            alert(this.lang.saveError);
        }
    },
    
    jumpToSection(tagName) {
        const editor = this.elements.editor;
        const tag = `<${tagName}`;
        const position = editor.value.indexOf(tag);
        if (position === -1) return;

        editor.focus();
        editor.setSelectionRange(position, position);
        editor.blur(); 
        editor.focus();
        editor.setSelectionRange(position, position);
    },

    setUnsavedChanges(isUnsaved) {
        this.state.hasUnsavedChanges = isUnsaved;
        document.title = isUnsaved ? `* ${this.state.fileName}` : this.state.fileName;
    },

    // --- Search & Replace ---

    updateSearchResults() {
        const searchTerm = this.elements.findInput.value;
        this.elements.matchCountSpan.textContent = '';
        
        if (!searchTerm) {
            this.state.searchResults = { term: '', indices: [], currentIndex: -1 };
            return;
        }

        if (this.state.searchResults.term === searchTerm) return;
        
        this.state.searchResults.term = searchTerm;
        this.state.searchResults.indices = [];
        this.state.searchResults.currentIndex = -1;
        
        const escapedTerm = this.utils.escapeRegExp(searchTerm);
        const regex = new RegExp(escapedTerm, 'gi');
        let match;
        while ((match = regex.exec(this.elements.editor.value)) !== null) {
            this.state.searchResults.indices.push(match.index);
        }
        
        if (this.state.searchResults.indices.length > 0) {
            this.elements.matchCountSpan.textContent = `${this.state.searchResults.indices.length} ${this.lang.matches}`;
        }
    },

    findNext() {
        this.updateSearchResults();
        const { indices } = this.state.searchResults;
        if (indices.length === 0) return;
        
        this.state.searchResults.currentIndex = (this.state.searchResults.currentIndex + 1) % indices.length;
        const startIndex = indices[this.state.searchResults.currentIndex];
        
        this.elements.editor.focus();
        this.elements.editor.setSelectionRange(startIndex, startIndex + this.state.searchResults.term.length);
    },

    replaceCurrent() {
        const { term } = this.state.searchResults;
        const replaceTerm = this.elements.replaceInput.value;
        const { selectionStart, selectionEnd } = this.elements.editor;

        if (!term || selectionStart === selectionEnd) {
            this.findNext();
            return;
        }
        
        const selectedText = this.elements.editor.value.substring(selectionStart, selectionEnd);
        if (selectedText.toLowerCase() === term.toLowerCase()) {
            this.elements.editor.setRangeText(replaceTerm, selectionStart, selectionEnd, 'end');
            this.setUnsavedChanges(true);
            this.updateSearchResults();
        }
        this.findNext();
    },

    replaceAll() {
        const term = this.elements.findInput.value;
        const replaceTerm = this.elements.replaceInput.value;
        if (!term) return;

        this._modifyContent(new RegExp(this.utils.escapeRegExp(term), 'gi'), replaceTerm);
    },

    // --- Event Handlers ---

    handleEditorInput() {
        if (!this.state.hasUnsavedChanges) {
            this.setUnsavedChanges(true);
        }
        this.state.searchResults.term = null;
        this.utils.debounce(this.updateLineNumbers.bind(this), this.config.debounceDelay)();
    },

    handleEditorKeyDown(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const { selectionStart, selectionEnd, value } = this.elements.editor;
            const indent = this.config.indentUnit;

            if (value.substring(selectionStart, selectionEnd).includes('\n')) {
                let lineStart = value.lastIndexOf('\n', selectionStart - 1) + 1;
                const affectedText = value.substring(lineStart, selectionEnd);
                let newText;

                if (e.shiftKey) { // Outdent
                    newText = affectedText.split('\n').map(line =>
                        line.startsWith(indent) ? line.substring(indent.length) : line
                    ).join('\n');
                } else { // Indent
                    newText = affectedText.split('\n').map(line => indent + line).join('\n');
                }
                this.elements.editor.setRangeText(newText, lineStart, selectionEnd, 'select');
            } else { // Single line
                if (!e.shiftKey) {
                    this.elements.editor.setRangeText(indent, selectionStart, selectionEnd, 'end');
                }
            }
            this.setUnsavedChanges(true);
        }
    },
    
    handleGlobalKeyDown(e) {
        const isModalOpen = this.elements.helpModal.style.display === 'block' || this.elements.searchModal.style.display === 'block';
        const isCtrl = e.ctrlKey || e.metaKey;
        const key = e.key.toLowerCase();

        if (e.altKey && key === 'h') {
            e.preventDefault();
            this.toggleModal('help');
        }

        if (isModalOpen) {
            if (key === 'escape') {
                e.preventDefault();
                if (this.elements.searchModal.style.display === 'block') this.toggleModal('search');
                if (this.elements.helpModal.style.display === 'block') this.toggleModal('help');
            } else if (key === 'enter' && !e.shiftKey && this.elements.searchModal.style.display === 'block') {
                e.preventDefault();
                this.elements.findNextBtn.click();
            }
            return;
        }

        if (isCtrl) {
            if (key === 's') { e.preventDefault(); this.saveFile(); }
            if (key === 'o') { e.preventDefault(); this.openFile(); }
            if (e.shiftKey) {
                if (e.code === 'Digit1') { e.preventDefault(); this.jumpToSection('style'); }
                if (e.code === 'Digit2') { e.preventDefault(); this.jumpToSection('script'); }
                if (e.code === 'Digit3') { e.preventDefault(); this.jumpToSection('body'); }
            }
        } else if (e.altKey) {
            if (key === 'n') { e.preventDefault(); this.newFile(); }
            if (key === 'f') { e.preventDefault(); this.toggleModal('search'); }
            if (key === 'w') { e.preventDefault(); this.cleanWhitespace(); }
            if (key === 'l') { e.preventDefault(); this.removeEmptyLines(); } // NEW
            if (key === 'p') { e.preventDefault(); this.previewInNewTab(); } // NEW
            if (key === 't') { e.preventDefault(); window.open(window.location.href, '_blank'); }
        }
    },
    
    handleBeforeUnload(e) {
        if (this.state.hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    },

    // --- UI & Utilities ---

    updateStaticUIText() {
        document.title = this.lang.title;
        const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        
        const shortcuts = [ // NEW: Added Preview and Remove Empty Lines shortcuts
            { key: 'Ctrl + O', action: this.lang.helpOpenFile },
            { key: 'Ctrl + S', action: this.lang.helpSaveFile },
            { key: 'Alt + N', action: this.lang.helpNewFile },
            { isSeparator: true },
            { key: 'Alt + F', action: this.lang.helpSearchReplace },
            { key: 'Alt + P', action: this.lang.helpPreview },
            { key: 'Alt + H', action: this.lang.helpToggleHelp },
            { isSeparator: true },
            { key: 'Alt + W', action: this.lang.helpCleanWhitespace },
            { key: 'Alt + L', action: this.lang.helpRemoveEmptyLines },
            { isSeparator: true },
            { key: 'Ctrl + Shift + 1', action: this.lang.helpJumpStyle },
            { key: 'Ctrl + Shift + 2', action: this.lang.helpJumpScript },
            { key: 'Ctrl + Shift + 3', action: this.lang.helpJumpBody },
            { isSeparator: true },
            { key: 'Alt + T', action: this.lang.helpNewTab },
            { key: 'Tab', action: this.lang.helpIndent },
            { key: 'Shift + Tab', action: this.lang.helpOutdent },
        ];
        
        this.elements.helpList.innerHTML = shortcuts.map(item => {
            if (item.isSeparator) return `<hr style="border-color: ${borderColor}; margin: 10px 0;">`;
            return `<li><strong>${item.key}</strong> ${item.action}</li>`;
        }).join('');

        this.elements.helpMainTitle.textContent = this.lang.mainTitle;
        this.elements.helpTitle.textContent = this.lang.helpTitle;
        this.elements.searchMainTitle.textContent = this.lang.mainTitle;
        this.elements.searchTitle.textContent = this.lang.searchTitle;
        this.elements.findLabelText.textContent = this.lang.findLabel;
        this.elements.replaceLabel.textContent = this.lang.replaceLabel;
        this.elements.findNextBtn.textContent = this.lang.findNext;
        this.elements.replaceBtn.textContent = this.lang.replace;
        this.elements.replaceAllBtn.textContent = this.lang.replaceAll;
    },

    utils: {
        debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        },
        escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    }
};

window.addEventListener('load', () => CodeEditor.init());

</script>

</body>
</html>
